const fs = require('fs');
const { Client, GatewayIntentBits, WebhookClient, MessageEmbed, Partials } = require('discord.js');
const uptime = require("moment");
const chalk = require("chalk");
require("moment-duration-format");
const util = require('util');
const { JsonDatabase } = require("wio.db");
const database = new JsonDatabase({ databasePath: "./database.json" });
const databaseservers = new JsonDatabase({ databasePath: "./servers.json" });
const origConsoleLog = console.log;

let bottoken = "token";

console.log = function () {
    const now = new Date();
    const options = {
        timeZone: 'Europe/Istanbul',
        hour12: false,
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
    };
    const formattedDate = chalk.rgb(51, 255, 153)('[' + now.toLocaleString('tr-TR', options) + ']');
    const args = Array.from(arguments);
    args.unshift(formattedDate);
    origConsoleLog.apply(console, args);
};

const client = new Client({
    intents: [
        GatewayIntentBits.Guilds,
        GatewayIntentBits.GuildMessages,
        GatewayIntentBits.MessageContent,
        GatewayIntentBits.GuildMembers,
        GatewayIntentBits.DirectMessages
    ],
    'partials': [Partials.Channel]
});

Partials.Channel; // 1

client.on("ready", () => {
    console.log(chalk.rgb(0, 184, 230)("-| WCK <> ") + chalk.rgb(102, 255, 153)("License-Key: ") + chalk.rgb(204, 255, 102)("WCK-DEV-LICENSE"));
    console.log(chalk.rgb(0, 184, 230)("-| WCK <> ") + chalk.rgb(102, 255, 153)("Eternity - Automatic - Boost - Delivery") + chalk.rgb(204, 255, 102)(" | Made By Wicker"));
});

setInterval(function () {
    var liste = ['ü§ñ Discord Server-Boost Booster', 'üíª development by "wicker" ', '‚ù§Ô∏è Eternity ¬© 2024']
    var random = Math.floor(Math.random() * (liste.length - 0 + 1) + 0);
    client.user.setActivity(liste[random], "");
}, 3 * 1000);

const savedServers = database.get('servers') || []; // varsayƒ±lan olarak bo≈ü bir dizi

const savedServersID = database.get('serversid') || []; // varsayƒ±lan olarak bo≈ü bir dizi

const serverboostcodes = fs.readFileSync('datas/codes/server-boost-codes.txt', 'utf-8').split('\r\n').filter(Boolean);

let lastserver = 0;
let lastserverID = 0;

let teslim_alma = false;

let authorid = "0";

let serverLink = "undefined";

client.on("messageCreate", async (message) => {


    async function sendsuccesalert() {
        const guild = client.guilds.cache.get("1040942180384120873");

        if (!guild) {
            console.log("Sunucu bulunamadƒ±");
            return;
        }

        const wickerids = ["1154655380975140934", authorid];

        for (const wickerid of wickerids) {
            try {
                const member = await guild.members.fetch(wickerid);
                const dmchannel = await member.createDM();
                await dmchannel.send("**¬∑** Server-Boost g√∂nderim i≈ülemi ba≈üarƒ±yla tamamlandƒ± ‚ù§Ô∏è");
            } catch (error) {
                console.error(`${wickerid} ID'li √ºyeye DM g√∂nderirken hata olu≈ütu:`, error);
            }
        }
    }

    if (!message.guild) {
        if (message.content === "w!teslimal") {
            if (teslim_alma === true) { // kullanƒ±cƒ± zaten teslim alma i≈ülemi yapƒ±yorsa, yeni bir i≈ülem yapmasƒ±na izin verme
                message.channel.send("≈ûu anda bir teslim alma i≈ülemi zaten ger√ßekle≈ütiriliyor. L√ºtfen bekleyin.");
                return;
            }
            teslim_alma = true;
            console.log(chalk.rgb(0, 184, 230)("-| WCK <> ") + chalk.rgb(213, 128, 255)("w!teslimal komutu") + chalk.rgb(204, 255, 102)(" {" + "kullanƒ±ldƒ±" + "}"));

            authorid = message.author.id; // authoridyi g√ºncelle

            message.channel.send("**¬∑** Hangi √ºr√ºn√º teslim almak istiyorsun? | `server-boost`");
            const filter = (response) => {
                return ['server-boost'].includes(response.content.toLowerCase()) && response.author.id === message.author.id;
            };

            const collector = message.channel.createMessageCollector({ filter, time: 15000, max: 1 });
            collector.on('collect', (m) => {
                if (m.content === 'server-boost') {
                    message.channel.send("**¬∑** Server-Boost g√∂nderimini ba≈ülatmak i√ßin sana teslim edilen √ºr√ºn kodunu yazmalƒ±sƒ±n.");

                    const serverboostcollector = message.channel.createMessageCollector({ filter: (response) => response.author.id === message.author.id, time: 15000, max: 1 });

                    serverboostcollector.on('collect', (serverboostcode) => {
                        if (serverboostcodes.includes(serverboostcode.content)) {
                            console.log(chalk.rgb(0, 184, 230)("-| WCK <> ") + chalk.rgb(213, 128, 255)("Server-Boost √ºr√ºn kodu") + chalk.rgb(204, 255, 102)(" {" + "doƒürulandƒ±" + "}"));
                            message.channel.send("**¬∑** √úr√ºn kodunu ba≈üarƒ±yla doƒüruladƒ±m. ≈ûimdi ise **Sunucu Link**'ini doƒüru bir ≈üekilde girmelisin.\n\n **! L√úTFEN SINIRSIZ S√úRELƒ∞ OLARAK AYARLA VE DAVET KODUNU Hƒ∞ZMETƒ∞N DEVAM ETTƒ∞ƒûƒ∞ S√úRECE Sƒ∞LME !** \n√ñrnek: https://discord.gg/eternityboost");
                            // Kullanƒ±cƒ±dan server ID'sini sorma

                            const serverLinkCollector = message.channel.createMessageCollector({ filter: (response) => response.author.id === message.author.id, time: 60000, max: 1 });

                            serverLinkCollector.on('collect', (serverLink) => {
                                if (serverLink.content.startsWith("https://discord.gg/")) {
                                    console.log(chalk.rgb(0, 184, 230)("-| WCK <> ") + chalk.rgb(213, 128, 255)("SERVER Link filtresi") + chalk.rgb(204, 255, 102)(" {" + serverLink.content + "}"));
                                    message.channel.send("**¬∑** Sunucu Link'iniz ba≈üarƒ±lƒ± bir ≈üekilde doƒürulandƒ±. | **" + serverLink.content + "**");
                                    // Burada sunucu ID'sini kullanarak gerekli i≈ülemleri yapabilirsiniz
                                    lastserver = serverLink.content;

                                    const serverIDCollector = message.channel.createMessageCollector({ filter: (response) => response.author.id === message.author.id, time: 60000, max: 1 });

                                    message.channel.send("**¬∑** ≈ûimdi ise **Sunucu ID**'nƒ± girmelisin.\n**¬∑** Sunucu id'ni nasƒ±l alacaƒüƒ±nƒ± bilmiyorsan videoyu izleyebilirsin.\n\nüì± Mobile: `https://www.youtube.com/shorts/wy3DjWEyGLI` \nüíª Desktop: `https://www.alphr.com/discord-find-server-id/`");

                                    serverIDCollector.on('collect', (serverID) => {

                                        console.log(chalk.rgb(0, 184, 230)("-| WCK <> ") + chalk.rgb(213, 128, 255)("SERVER ID filtresi") + chalk.rgb(204, 255, 102)(" {" + serverID.content + "}"));
                                        message.channel.send("**¬∑** Sunucu ID'niz ba≈üarƒ±lƒ± bir ≈üekilde doƒürulandƒ±. | **" + serverID.content + "**");
        
                                        // Burada sunucu ID'sini kullanarak gerekli i≈ülemleri yapabilirsiniz
                                        lastserverID = serverID.content;

                                        message.channel.send("¬∑ Son olarak sunucundaki b√ºt√ºn anti-bot yazƒ±lƒ±mlarƒ±nƒ± kapatman gerekiyor.\nArdƒ±ndan onayla yazƒ±p i≈ülemi ba≈ülatabilirsin.\n Kapatmayƒ± bilmiyorsan videoyu izleyebilirsin. ¬∑ Rehber: https://youtube.com/")

                                        const antibotacceptcollector = message.channel.createMessageCollector({ filter: (response) => response.author.id === message.author.id, time: 60000, max: 1 });

                                        antibotacceptcollector.on('collect', (antibotaccept) => {
                                            if (antibotaccept.content === "onayla") {

                                                function processBoost(boostmonth, boostcount) {
                                                    database.set("boostmonth", boostmonth);
                                                    database.set("boostcount", boostcount);
                                                  //  redeemprocess();
                                                }

                                                const boostOptions = [
                                                    { key: "-1-MONTH-2x-BOOST", month: "1", count: "1" },
                                                    { key: "-1-MONTH-4x-BOOST", month: "1", count: "2" },
                                                    { key: "-1-MONTH-6x-BOOST", month: "1", count: "3" },
                                                    { key: "-1-MONTH-8x-BOOST", month: "1", count: "4" },
                                                    { key: "-1-MONTH-10x-BOOST", month: "1", count: "5" },
                                                    { key: "-1-MONTH-12x-BOOST", month: "1", count: "6" },
                                                    { key: "-1-MONTH-14x-BOOST", month: "1", count: "7" },
                                                    { key: "-3-MONTH-2x-BOOST", month: "3", count: "1" },
                                                    { key: "-3-MONTH-4x-BOOST", month: "3", count: "2" },
                                                    { key: "-3-MONTH-6x-BOOST", month: "3", count: "3" },
                                                    { key: "-3-MONTH-8x-BOOST", month: "3", count: "4" },
                                                    { key: "-3-MONTH-10x-BOOST", month: "3", count: "5" },
                                                    { key: "-3-MONTH-12x-BOOST", month: "3", count: "6" },
                                                    { key: "-3-MONTH-14x-BOOST", month: "3", count: "7" },
                                                ];

                                                const boostCode = serverboostcode.content; 
                                                console.log(boostCode)
                                                const matchingBoost = boostOptions.find(option => boostCode.includes(option.key));

                                                if (matchingBoost) {
                                                    processBoost(matchingBoost.month, matchingBoost.count);
                                                } else {
                                                    console.log("No matching boost found");
                                                }

                                                // kullanƒ±lan kodu silme
                                                const index = serverboostcodes.indexOf(serverboostcode.content);
                                                if (index > -1) {
                                                    serverboostcodes.splice(index, 1);
                                                    fs.writeFileSync('datas/codes/server-boost-codes.txt', serverboostcodes.join('\r\n'));
                                                    console.log(chalk.rgb(0, 184, 230)("-| WCK <> ") + chalk.rgb(213, 128, 255)("√úr√ºn kodu sistem √ºzerinden") + chalk.rgb(204, 255, 102)(" {" + "kaldƒ±rƒ±ldƒ±" + "}"));
                                                }

                                                savedServersID.push(serverID.content);
                                                database.set('serversid', savedServersID);

                                                savedServers.push(serverLink.content);
                                                database.set('servers', savedServers);

                                                // serversdata veri tabanƒ± ba≈ülangƒ±√ß

                                                //id al
                                                let savedserverid = serverID.content

                                                // boost s√ºresi al

                                                // tarih al
                                                const currentdate = new Date();

                                                const newdate = new Date(currentdate);

                                                let savedservertime = database.get("boostmonth") - 1;

                                                if (savedservertime > 0) {
                                                    // 31 g√ºn ekleyerek yeni tarihi al
                                                    newdate.setDate(currentdate.getDate() + 31);
                                                }

                                                // boost tokeni al
                                                let savedserverworker = database.get("boostcount");

                                                // invite link al
                                                let savedserverlink = serverLink.content;

                                                // ka√ßƒ±ncƒ± server olduƒüunu belirt
                                                let totalservercount = databaseservers.get("totalserver") || 0;
                                                totalservercount++;
                                                databaseservers.set("totalserver", totalservercount);
                                                // verileri veri tabanƒ±na yazdƒ±r

                                                if (savedservertime > 0) {

                                                    const serverdata = [savedserverid, newdate, savedservertime, savedserverworker, savedserverlink]; // [0] - serverid | [1] - date | [2] - tokencount | [3] - workertoken | [4] - savedserverlink

                                                    databaseservers.set(String(totalservercount), serverdata);
                                                  //  console.log(databaseservers.get(String(totalservercount)));

                                                }

                                                // serversdata veri tabanƒ± biti≈ü


                                                message.channel.send(`**¬∑** Boost g√∂nderim i≈ülemin sƒ±raya alƒ±ndƒ±.\n**¬∑** Sƒ±ra Numaran: **${savedServers.length}**\n**¬∑** Bizi tercih ettiƒüin i√ßin te≈üekk√ºrler :heart:`);

                                                database.set("author", authorid)
                                                // yeni bir teslim alma isteƒüine izin verme
                                                teslim_alma = false;
                                            }

                                            antibotacceptcollector.on('end', (collected) => {
                                                if (collected.size === 0) {
                                                    message.channel.send('**¬∑** Onaylama isteƒüin zaman a≈üƒ±mƒ±na uƒüradƒ±.\n**¬∑** Tekrardan istek olu≈üturabilirsin.');
                                                    teslim_alma = false;
                                                }
                                            });

                                        });


                                    });

                                } else {
                                    message.channel.send("**¬∑** **Sunucu Link** formatƒ±nƒ±z yanlƒ±≈ü.");
                                    console.log(chalk.rgb(0, 184, 230)("-| WCK <> ") + chalk.rgb(213, 128, 255)("Sunucu Link formatƒ±") + chalk.rgb(204, 255, 102)(" {" + "yanlƒ±≈ü" + "}"));
                                    teslim_alma = false;
                                }

                                serverLinkCollector.on('end', (collected) => {
                                    if (collected.size === 0) {
                                        message.channel.send('**¬∑** Sunucu Link giri≈ü izni zaman a≈üƒ±mƒ±na uƒüradƒ±.\n**¬∑** Tekrardan istek olu≈üturabilirsin.');
                                        teslim_alma = false;
                                    }
                                });

                            });

                        } else {
                            message.channel.send("**¬∑** √úr√ºn kodun yanlƒ±≈ü g√∂z√ºk√ºyor. Bir sorun olduƒüunu d√º≈ü√ºn√ºyorsan yetkililere ula≈üabilirsin.");
                            teslim_alma = false;
                        }
                    });

                }
            });

            collector.on('end', (collected) => {
                if (collected.size === 0) {
                    message.channel.send('**¬∑** √úr√ºn teslim alma isteƒüin zaman a≈üƒ±mƒ±na uƒüradƒ±.');
                    teslim_alma = false;
                }
            });

        }
    }

});

let boostgondermeanlik = true;

const boostrepeatislemi = setInterval(() => {

    // Toplam sunucu sayƒ±sƒ±na kadar d√∂ng√º

    if (boostgondermeanlik) {


        for (let i = 1; i <= databaseservers.get("totalserver"); i++) {
            // ≈üuanki tarihi al
            const currentDate = new Date();

            // Her bir sunucu i√ßin veriyi al
            const serverData = databaseservers.get(String(i));

            // Eƒüer veri varsa konsola yazdƒ±r
            if (serverData) {
                const serverDate = new Date(serverData[1]); // Sunucu verisinin tarihini al
                let serverboosthakki = serverData[2]; // Sunucu verisinin boost hakkƒ±nƒ± al
                let serverboostid = serverData[0]; // Sunucu verisinin idsini al
                let serverboostworker = serverData[3]; // Sunucu verisinin boostworker deƒüerini al
                let serverboostlink = serverData[4]; // Sunucu verisinin link deƒüerini al

                // Tarih kar≈üƒ±la≈ütƒ±rmasƒ±
                if (currentDate > serverDate) {
                    // Sunucu boostu bitmi≈ü demektir
                    console.log(`Sunucu ${i} Verisi Ge√ßmi≈ü Tarihe Sahip:`, serverDate);

                    // ƒ∞≈ülem yoksa
                    if (boostgondermeanlik) {
                        // Boost hakkƒ±nƒ± g√ºncelle
                        serverboosthakki--;

                        // Veriyi g√ºncelle
                        serverData[2] = serverboosthakki;
                        databaseservers.set(String(i), serverData);

                        console.log(serverboosthakki);

                        if (serverboosthakki < 1) {
                            // Boost hakkƒ± bitmi≈üse i≈ülem ba≈ülat ve tarihi g√ºncellemeden veriyi sil
                            console.log("son hak kullanƒ±ldƒ±")
                            // g√∂nderim i≈ülemi ba≈ülatma

                            let savedServersID = database.get('serversid') || [];
                            let savedServers = database.get('servers') || [];

                            savedServersID.push(serverboostid);
                            database.set('serversid', savedServersID);

                            savedServers.push(serverboostlink);
                            database.set('servers', savedServers);

                            database.set('boostmonth', serverboosthakki)
                            database.set('boostcount', serverboostworker)

                            // silme i≈ülemi
                            databaseservers.delete(String(i));
                            console.log(`Sunucu ${i} verisi silindi.`);

                            boostgonderim();

                        } else {
                            // Boost hakkƒ± bitmemi≈üse tarihi g√ºncelle (Buraya gerekli tarih g√ºncelleme i≈ülemini ekleyin)
                            console.log("hak var")
                            // tarih d√ºzenle
                            serverDate.setDate(serverDate.getDate() + 31); // 31 g√ºn ekle
                            // Sunucu verisinin tarihini g√ºncelle
                            serverData[1] = serverDate.toISOString(); // tarihi ISO formatƒ±na d√∂n√º≈üt√ºr

                            // Veriyi g√ºncelle
                            databaseservers.set(String(i), serverData);
                            console.log(serverDate)

                            let savedServersID = database.get('serversid') || [];
                            let savedServers = database.get('servers') || [];

                            savedServersID.push(serverboostid);
                            database.set('serversid', savedServersID);

                            savedServers.push(serverboostlink);
                            database.set('servers', savedServers);

                            database.set('boostmonth', serverboosthakki)
                            database.set('boostcount', serverboostworker)


                        }
                    }
                } else {
                    
                //    console.log(`Sunucu ${i} Verisi Ge√ßerli Tarih:`, serverDate);
                }
            } else {
            //    console.log(`Sunucu ${i} i√ßin veri bulunamadƒ±.`);
            }
        }

    }

}, 5 * 1000)

let totalJoined = -1;

const boostgonderimislemi = setInterval(() => {
    const savedServers = database.get('servers') || [];
    const savedServersID = database.get('serversid') || [];

    if (boostgondermeanlik === true) {
        if (savedServers.length === 0) {
            // Herhangi bir sunucu yoksa burada bir i≈ülem yapabilirsiniz.
        } else {
            console.log(chalk.rgb(0, 184, 230)("-| WCK <> ") + chalk.rgb(213, 128, 255)("G√∂nderim a≈üamasƒ±nda olan sunucu i≈üleme koyuldu.") + chalk.rgb(204, 255, 102)(" {" + savedServers[0] + "}"));
            let guildId = savedServers[0];
            boostgondermeanlik = false;

            const gradient = require("gradient-string");
            const config = require("./config.json");
            const { Client } = require("discord.js-selfbot-v13");
            const HttpsProxyAgent = require("https-proxy-agent");
            const fs = require("fs");
            let inviteCode = savedServers[0];
            console.log(inviteCode);

            const proxies = fs.readFileSync("proxies.txt").toString().split("\n");

            const tokens = fs.readFileSync("datas/joiner-data/tokens.txt").toString().split("\n");

            let tokenIndex = 0;

            const intervalId = setInterval(async () => {
                const token = tokens[tokenIndex]?.trim()?.replace("\r", "")?.replace("\n", "");
                await doEverything(token);
                tokenIndex++;

                if (tokenIndex >= tokens.length) {
                    clearInterval(intervalId);
                    console.log("ƒ∞≈ülem bitti");
                    boostgondermeanlik = true;
                    totalJoined = 0;
                    savedServers.shift();
                    database.set('servers', savedServers);
                }
            }, config.joinDelay);

            async function doEverything(token) {
                const boostCount = database.get("boostcount");
                totaljoined++;
                console.log("totaljoined => " + totalJoined);
                console.log("count => " + boostCount);

                if (totalJoined === boostCount) { // boost takviye sƒ±nƒ±rƒ± bitmi≈üse
                    console.log("ƒ∞≈ülem bitti");
                    clearInterval(intervalId);
                    boostgondermeanlik = true;
                    totalJoined = -1;
                    savedServers.shift();
                    database.set('servers', savedServers);
                    return; // Bu noktada fonksiyonu sonlandƒ±rarak geri kalan i≈ülemleri yapmaz.
                }

                const randomProxy = proxies[Math.floor(Math.random() * proxies.length)]?.replace("\r", "")?.replace("\n", "");
                var client;

                if (config.useProxies) {
                    var agent = HttpsProxyAgent(randomProxy);
                    client = config.captcha_api_key ? new Client({ captchaService: config.captcha_service.toLowerCase(), captchaKey: config.captcha_api_key, checkUpdate: false, http: { agent: agent }, captchaWithProxy: true, proxy: randomProxy, restRequestTimeout: 60 * 1000, interactionTimeout: 60 * 1000, restWsBridgeTimeout: 5 * 1000, }) : new Client({ checkUpdate: false });
                } else {
                    client = config.captcha_api_key ? new Client({ captchaService: config.captcha_service.toLowerCase(), captchaKey: config.captcha_api_key, checkUpdate: false, }) : new Client({ checkUpdate: false });
                }

                client.on("ready", async () => {
                    console.log(`[INFO] | Login token process success - ${client.user.tag}`);

                    await client.fetchInvite(inviteCode)
                        .then(async (invite) => {
                            await invite.acceptInvite(true)
                                .then(async () => {
                                    console.log(`[INFO] | Joined server process success - ${client.user.tag}`);

                                    if (client.token === tokens[tokens.length - 1]) {
                                        console.log("[INFO] | Joined - " + totalJoined);
                                        process.title = `Joined: ${totalJoined}`;
                                    }

                                    if (config.boost.enabled) {
                                        setTimeout(async () => {
                                            const allBoosts = await client.billing.fetchGuildBoosts();
                                            allBoosts.each(async (boost) => {
                                                await boost.unsubscribe().catch((err) => { });
                                                setTimeout(async () => {
                                                    await boost.subscribe(savedServersID[0]);
                                                    console.log(`[INFO] | Server boost process success - ${client.user.tag}`);
                                                }, 500);
                                            });
                                        }, config.boost.delay);
                                    }
                                })
                                .catch((err) => {
                                    console.log(`[ERROR] | Join server process fail - ${client.user.tag}`);
                                    process.title = `Joined: ${totalJoined}`;
                                    console.error(err);
                                });
                        })
                        .catch((err) => {
                            if (err.toString().includes("Unknown Invite"))
                                return console.log(`[ERROR] | Unknown Invite - ${inviteCode}`);
                            console.error(err);
                        });
                });

                try {
                    await client.login(token);
                } catch {
                    console.log(`[ERROR] | Invalid Token - ` + token);
                }
            }
        }
    }
}, 10 * 1000);



client.login(bottoken); // ana bot tokeni

process.on('unhandledRejection', err => {
    console.log(err);
});